#!/usr/bin/env python3

import boto3
import csv

def get_ec2_instances():
    ec2 = boto3.client('ec2')
    response = ec2.describe_instances()

    instances_data = []

    for reservation in response.get('Reservations', []):
        for instance in reservation.get('Instances', []):
            instance_id = instance.get('InstanceId', 'N/A')
            instance_type = instance.get('InstanceType', 'N/A')
            public_ip = instance.get('PublicIpAddress', 'N/A')
            platform = instance.get('Platform', 'Linux/UNIX')  # If not Windows, Platform is usually None, so mark as Linux/UNIX

            # OS version is not directly provided. Platform is Windows or None (Linux/UNIX).
            # Sometimes tag 'OS' or 'Version' might be used; look for tags
            os_version = platform

            # Extract instance Name tag if exists
            name = 'N/A'
            tags = instance.get('Tags', [])
            for tag in tags:
                if tag['Key'] == 'Name':
                    name = tag['Value']
                # Optionally look for other tags such as OS or Version for more info

            instances_data.append({
                'Name': name,
                'InstanceId': instance_id,
                'InstanceType': instance_type,
                'OSVersion': os_version,
                'PublicIPv4': public_ip
            })
    return instances_data

def export_to_csv(data, filename='ec2_instances.csv'):
    with open(filename, mode='w', newline='') as csvfile:
        fieldnames = ['Name', 'InstanceId', 'InstanceType', 'OSVersion', 'PublicIPv4']
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)

        writer.writeheader()
        for instance in data:
            writer.writerow(instance)

def main():
    instances = get_ec2_instances()
    export_to_csv(instances)
    print(f"Exported {len(instances)} instances to ec2_instances.csv")

if __name__ == '__main__':
    main()
